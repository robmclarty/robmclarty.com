<!DOCTYPE html>
<html lang="en"><script type="text/javascript" async="" src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/ga.js"></script><script type="module" src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/hook.js"></script><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><script src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/analytics.js" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app211.us.archive.org';v.server_ms=304;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/bundle-playback.js" charset="utf-8"></script>
<script type="text/javascript" src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/wombat.js" charset="utf-8"></script>
<script type="text/javascript">
  __wm.init("http://web.archive.org/web");
  __wm.wombat("http://robmclarty.com:80/blog/how-to-install-image-magick-and-setup-paperclip","20180731055857","http://web.archive.org/","web","/_static/",
	      "1533016737");
</script>
<link rel="stylesheet" type="text/css" href="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->

<meta charset="utf-8">
<title>How to Install Image Magick and Setup Paperclip // Rob McLarty</title>
<meta content="Handle file uploads and server-side image processing in your Rails 4 app with Paperclip and Image Magick." name="description">
<meta content="Rob McLarty" name="application-name">
<meta content="Rob McLarty" name="author">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="IE-edge,chrome=1" http-equiv="X-UA-Compatible">
<meta content="no" http-equiv="MSThemeCompatible">
<link href="http://web.archive.org/web/20180731055857/http://robmclarty.com/feed" rel="alternate" title="RLog-Feed" type="application/atom+xml">
<link href="http://web.archive.org/web/20180731055857im_/http://robmclarty.com/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">
<link href="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/application-4bf5c58eeb36f7ffe772634b49b3ee56.css" media="all" rel="stylesheet">

<meta content="authenticity_token" name="csrf-param">
<meta content="2xDg4lucigcJ7Rdc8yL5LKMUFaj6oNVtiPsyszWRQ+M=" name="csrf-token">

</head>
<body class=""><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" style="display: block; direction: ltr;" lang="en">
</div><div id="wm-ipp-print">The Wayback Machine - 
http://web.archive.org/web/20180731055857/http://robmclarty.com:80/blog/how-to-install-image-magick-and-setup-paperclip</div>
<div id="donato" style="position:relative;width:100%;">
  <div id="donato-base">
    <iframe id="donato-if" src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/donate.html" scrolling="no" style="width:100%; height:100%" frameborder="0">
    </iframe>
  </div>
</div><script type="text/javascript">
__wm.bt(650,27,25,2,"web","http://robmclarty.com/blog/how-to-install-image-magick-and-setup-paperclip","20180731055857",1996,"/_static/",["/_static/css/banner-styles.css?v=omkqRugM","/_static/css/iconochive.css?v=qtvMKcIJ"], "False");
  __wm.rw(1);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->
<header class="global-header" style="background-image: url('/web/20180731055857im_/http://robmclarty.com/system/posts/banners/14/paperclips_large.jpg?1380645331');">
<h1 class="logo">Rob McLarty</h1>
<a alt="Back to Homepage" class="main-button" href="http://web.archive.org/web/20180731055857/http://robmclarty.com/blog" id="main-button" title="Back to Homepage">
How to Install Image Magick and Setup Paperclip Banner
</a>
</header>
<div class="main">

<article class="post" id="post-14">
<h1 id="post-title">How to Install Image Magick and Setup Paperclip</h1>
<h2>Handle file uploads and server-side image processing in your Rails 4 app with Paperclip and Image Magick.</h2>
<p>After I've got my basic app setup on my production server the next 
major component I usually find myself installing is the ability to 
handle file uploads and doing some server-side processing on any upload 
images. This comes in handy for a variety of applications from file 
attachments to user avatars. Every app likely needs a way for its users 
to get stuff from their computer to the cloud.</p>

<p>In this article, I'll be assuming you've already setup your app along the lines of my previous <a href="http://web.archive.org/web/20180731055857/http://robmclarty.com/blog/how-to-setup-a-production-server-for-rails-4">two</a> <a href="http://web.archive.org/web/20180731055857/http://robmclarty.com/blog/how-to-deploy-a-rails-4-app-with-git-and-capistrano">posts</a>
 and now want to include the ability for your users to include avatar 
images along with their profiles. I'll show you have to install <a href="http://web.archive.org/web/20180731055857/http://www.imagemagick.org/">Image Magick</a> from source, setup the <a href="http://web.archive.org/web/20180731055857/https://github.com/thoughtbot/paperclip">Paperclip</a> gem, and include some basic image functionality into your Rails app.</p>

<p>There are certainly plenty of other libraries you could opt for, and 
you might need to handle different file types (not just images). I find 
Image Magick to have great support on multiple platforms with a plethora
 of options to cover nearly all of your image manipulation needs. On the
 application side of things, I like using the Paperclip gem for its 
simplicity and focused utility (it doesn't try to tell you how to do 
things, but gives you flexible options to adapt to different 
environments). I'm not trying to say these are your only options, just 
that these work well and are a good place to start as far as "getting 
stuff into the cloud" is concerned.</p>

<blockquote><p>Back when I first started using Rails I used <a href="http://web.archive.org/web/20180731055857/https://github.com/technoweenie/attachment_fu">Attachment Fu</a>. But this has long since stopped receiving updates. An alternative file upload gem that I recommend is <a href="http://web.archive.org/web/20180731055857/https://github.com/carrierwaveuploader/carrierwave">Carrier Wave</a>.
 And on the front-end of things, there are some nice JS libraries out 
there for making a more pleasant user experience (e.g., progress bars, 
previews, cropping adjustments) like <a href="http://web.archive.org/web/20180731055857/http://blueimp.github.io/jQuery-File-Upload/">jquery.fileupload</a> and <a href="http://web.archive.org/web/20180731055857/http://www.dropzonejs.com/">dropzone.js</a>. Feel free to explore these options because I know they can add a great deal of value to your app.</p></blockquote>

<h3>Install Image Magick</h3>

<p><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/wizard_large.jpg" alt="Image Magick"></p>

<p>Assuming you've got a Debian-based production environment like Ubuntu, you'll first need to install some dependencies using <code>apt-get</code>
 for the various image formats you'd like to support. Image Magick 
supports GIF out of the box, but you'll need to make sure the other 
formats you want to support are ready to go with the following CLI 
command (this adds support for JPEG, PNG, TIFF, and compression using 
BZip). Other dependencies can be referenced from the <a href="http://web.archive.org/web/20180731055857/http://www.imagemagick.org/download/delegates/">Image Magick delegates page</a>.</p>

<pre><code>&gt; sudo apt-get install libpng12-dev libglib2.0-dev zlib1g-dev libbz2-dev libtiff4-dev libjpeg8-dev
</code></pre>

<p>Next, you'll need to grab the source code and pull it over to your production server. I like to put all my source code stuff in <code>~/src</code>, but feel free to put it wherever you like. Image Magick maintains its <a href="http://web.archive.org/web/20180731055857/http://www.imagemagick.org/downloa">latest release here</a>.</p>

<pre><code>&gt; cd ~/src
&gt; wget http://www.imagemagick.org/download/ImageMagick.tar.gz
&gt; tar -xzvf ImageMagick.tar.gz
&gt; cd ImageMagick
</code></pre>

<p>You should now be inside the newly uncompressed ImageMagick directory. Next, we'll run the <code>configure</code>
 script and compile all the source code, finally installing it in the 
system. If you need to run any custom config options, a huge list of 
options can be referenced from the Image Magic <a href="http://web.archive.org/web/20180731055857/http://www.imagemagick.org/script/advanced-unix-installation.php">advanced unix installation page</a>.</p>

<pre><code>&gt; ./configure
&gt; make
&gt; sudo make install
</code></pre>

<p>Finally, you'll need to configure the dynamic linker run-time 
bindings to create the necessary links and cache to the most recent 
shared libraries using the <a href="http://web.archive.org/web/20180731055857/http://linux.die.net/man/8/ldconfig"><code>ldconfig</code> command</a>.</p>

<pre><code>&gt; sudo ldconfig /usr/local/lib
</code></pre>

<h3>Setup Paperclip</h3>

<p><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/thoughtbot_large.jpg" alt="Thoughtbot"></p>

<p>Once you've got Image Magic setup on your server, you'll want to 
include file attachment support inside your app. To do this, I like 
using Thoughtbot's Paperclip gem. How you do this specifically will 
depend on your app's needs. Here, I'm assuming you simply want to add 
avatar images to an existing User model in your app. You can reference 
how this works with <a href="http://web.archive.org/web/20180731055857/https://github.com/robmclarty/paperclip-example">this example app I put together</a>.</p>

<p>Include the paperclip gem in your Gemfile.</p>

<pre><code>gem 'paperclip', '~&gt; 3.0'
</code></pre>

<p>Update your app and install the gem using <code>bundle install</code>.</p>

<p>Generate a new migration to add avatar columns to the users table. 
The Paperclip gem includes a handy migration helper to do just this, but
 you can do it manually if you want (refer to <a href="http://web.archive.org/web/20180731055857/https://github.com/thoughtbot/paperclip">https://github.com/thoughtbot/paperclip</a> for documentation).</p>

<pre><code>&gt; rails g paperclip user avatar
</code></pre>

<p>This will add 4 columns to your model table for each attachment named in the following way (where <attachment>
 is the name of your attachment, in this case "avatar"). If you want to 
do the migration manually, these are the new columns you need to add.</attachment></p>

<ul>
<li><code>avatar_file_name</code> (string)</li>
<li><code>avatar_file_size</code> (int)</li>
<li><code>avatar_content_type</code> (string)</li>
<li><code>avatar_updated_at</code> (datetime)</li>
</ul>


<p>Once your migration is all setup, migrate the database.</p>

<pre><code>&gt; rake db:migrate
</code></pre>

<h3>Model Attachment Settings</h3>

<p><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/u2_numb_processing_4_large.jpg" alt="Manipulating image settings"></p>

<p>Now that the database is all setup, we can move to the application 
code. You'll need to let Rails know that your model has a Paperclip 
attachment by using Paperclip's built-in <code>has_attached_file</code> 
method. This allows you to specify a number of things including a custom
 path where the files should be saved, and in the case of images any 
alternate versions you want to generate (like thumbnails), as well as 
other command line options you want to pass. In the example app I use 
the following settings.</p>

<pre><code>has_attached_file :avatar, 
:path =&gt; ":rails_root/public/system/:attachment/:id/:basename_:style.:extension",
:url =&gt; "/system/:attachment/:id/:basename_:style.:extension",
:styles =&gt; {
  :thumb    =&gt; ['100x100#',  :jpg, :quality =&gt; 70],
  :preview  =&gt; ['480x480#',  :jpg, :quality =&gt; 70],
  :large    =&gt; ['600&gt;',      :jpg, :quality =&gt; 70],
  :retina   =&gt; ['1200&gt;',     :jpg, :quality =&gt; 30]
},
:convert_options =&gt; {
  :thumb    =&gt; '-set colorspace sRGB -strip',
  :preview  =&gt; '-set colorspace sRGB -strip',
  :large    =&gt; '-set colorspace sRGB -strip',
  :retina   =&gt; '-set colorspace sRGB -strip -sharpen 0x0.5'
}
</code></pre>

<p>What this is doing is storing all avatar image file attachments in: <code>:rails_root/public/system/:class/:attachment/:id/:basename_:style.:extension</code></p>

<p>For example, this might look like this when all the interpolation is filled in: <code>/www/myapp/releases/20081229172410/public/system/users/avatar/013/my_pic_thumb.png</code></p>

<p>The reason I'm using this structure is because I'm using Capistrano for deployment, which creates a <code>public/system</code> symlink to <code>shared/system</code> where all uploaded attachments can be stored outside of the <code>releases</code>
 directory thus persisting from deployment to deployment. You can choose
 to customize this path as you see fit (the above example is slightly 
different than the default).</p>

<p>In the "styles" option, you can specify as many named styles as you 
like. This will cause paperclip to generate additional versions of the 
uploaded image file (NOTE: this only works for images) using the named 
style (e.g., "imagename_stylename.extension"). For each style you can 
further define a size, filetype, and quality setting (in the case of 
JPEG). The size is defined according to the command line "geometry" 
option that you want to pass to Image Magick.</p>

<p>For example, if you want your thumbnails to be exactly 100x100 
pixels, but you don't want the image to be distorted (e.g., squished) 
and instead crop off any part of the image that doesn't fit 
proportionally, you would add the "#" symbol to the end of your size 
definition. In my example for "large" I'm only defining the first 
dimension (width) and using the "&gt;" symbol after it. This means that 
the image will be reduced in size such that the width is made to be 600 
pixels wide, and the height is simply adjusted proportionally. There are
 a lot of <a href="http://web.archive.org/web/20180731055857/http://www.imagemagick.org/script/command-line-processing.php#geometry">different options that can be used</a>.</p>

<p>Finally, I've added some custom "convert_options". This isn't 
absolutely necessary, but I'm including them here for your reference 
should you ever need to add more options (I had a hard time tracking 
down how to do this myself). Basically, you can add extra custom command
 line options here for each style (anything that <a href="http://web.archive.org/web/20180731055857/http://www.imagemagick.org/script/command-line-options.php">Image Magick's convert command</a> takes).</p>

<p>Here I'm setting a consistent colorspace of sRGB and stripping all 
the metadata to make the file as small as I can. Then, for the "retina" 
style, I'm saving it at twice the size of the "large" style, but then 
compressing it down to 30% quality, and further sharpening it by 0.5. 
This is simply a subjective setting that is based on my experimentation 
with different compression settings for double pixel density images (I 
found a little extra sharpening helped).</p>

<h3>Pro Tip: Use One Image To Rule Them All</h3>

<p>You can save a single thumbnail size, at double the pixel density, 
but drastically compressed, and it will retain an acceptable level of 
quality to the human eye (e.g., a 600 pixel wide image shown in a 300 
pixel wide space). The filesize is about the same as a higher quality 
1:1 ratio image (e.g., a 600px image compressed to 20-30% quality using 
JPEG would be approximately the same 40-50 KB as a 300px wide image 
compressed to 80-90% quality using JPEG), but it looks better on retina 
displays. I've just found that using a single, double density, highly 
compressed thumbnail file served to <em>all</em> devices/screens is a 
lot simpler to maintain compared to all the other crazy methods people 
are supporting like user-agent sniffing, the <picture> tag, or complicated SVG implementations. Make your life easier and balance compression with quality using a single file.</picture></p>

<p>See for yourself:</p>

<table style="font-size: 10px; line-height: 12px;" width="630" cellspacing="0" cellpadding="0" border="0">
    <tbody><tr>
      <td><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/retina_image_sample_A.jpg" alt="Double Density / Low Quality" style="border: none; width: 315px;" width="315" height="370"></td>
      <td><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/retina_image_sample_B.jpg" alt="Regular Density / High Quality" style="border: none; width: 315px;" width="315" height="370"></td>
    </tr>
    <tr>
      <td>Double Density (630x740px), 24% JPEG compression, 54 KB</td>
      <td>Normal Density (315x370px), 85% JPEG compression, 54 KB</td>
    </tr>
  </tbody></table>


<p>An example Image Magick CLI command would be something like this:</p>

<pre><code>&gt; convert -strip -quality 30% -resize 600x -sharpen 0x0.5 source.jpg output.jpg
</code></pre>

<p>Here's more on the subject of double density, low quality images:</p>

<ul>
<li><a href="http://web.archive.org/web/20180731055857/http://gored.hu/optmising_jpg_for_retina_display/">http://gored.hu/optmising_jpg_for_retina_display/</a></li>
<li><a href="http://web.archive.org/web/20180731055857/http://www.netvlies.nl/blog/design-interactie/retina-revolution">http://www.netvlies.nl/blog/design-interactie/retina-revolution</a></li>
<li><a href="http://web.archive.org/web/20180731055857/http://alidark.com/responsive-retina-image-mobile/">http://alidark.com/responsive-retina-image-mobile/</a></li>
</ul>


<h3>Validations</h3>

<p>Paperclip also includes some handy validation methods that you can 
take advantage of for handling these file attachments in your model. 
There are individual methods for each of 'presence', 'filesize', and 
'content type' as well as an all-in-one option (which I prefer). This is
 how you might write a validation for your attachment that requires it 
be present, between 0-10 megabytes in size, and is an image (e.g., jpeg,
 gif, png, or tiff).</p>

<pre><code>validates_attachment :avatar,
    :presence =&gt; true,
    :size =&gt; { :in =&gt; 0..10.megabytes },
    :content_type =&gt; { :content_type =&gt; /^image\/(jpeg|png|gif|tiff)$/ }
</code></pre>

<p>Note that the content_type expects a mime-type like "image/jpeg". In 
my example here I'm simply using a regular expression to match 
"image/whatever" for the <a href="http://web.archive.org/web/20180731055857/http://en.wikipedia.org/wiki/Internet_media_type#Type_image">different image mime-types</a>.</p>

<h3>Update Your Views (and Controllers)</h3>

<p>Now you just need to tell your Rails app to allow the new "avatar" 
parameter when you create/update the User model by adding it to the <code>params.require</code> line in the controller (this is the new way of doing <code>attr_accessible</code> in Rails 4) like this:</p>

<pre><code>def user_params
    params.require(:user).permit(:name, :description, :avatar)
end
</code></pre>

<p>Then, you'll want to add the actual form field for attaching the avatar file to the model in the <code>_form.html.erb</code> partial using something like the following:</p>

<pre><code>&lt;div class="field"&gt;
    &lt;%= f.label :avatar %&gt;&lt;br&gt;
    &lt;%= f.file_field :avatar %&gt;
&lt;/div&gt;
</code></pre>

<p><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/Screen_Shot_2013-09-30_at_2_002.jpg" alt="Attach a file to the form"></p>

<p>Then (this depends on how you want your app to work) you might want to show the avatar image on the User show page like this:</p>

<pre><code>&lt;p&gt;
    &lt;strong&gt;Avatar:&lt;/strong&gt;
    &lt;%= image_tag @user.avatar.url(:large) %&gt;
&lt;/p&gt;
</code></pre>

<p><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/Screen_Shot_2013-09-30_at_2.jpg" alt="enter image description here"></p>

<p>And maybe use the thumbnail in the User index page like this:</p>

<pre><code>&lt;td&gt;&lt;%= image_tag user.avatar.url(:thumb) %&gt;&lt;/td&gt;
</code></pre>

<p><img src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/Screen_Shot_2013-09-30_at_2_003.jpg" alt="enter image description here"></p>

<p>In these two "show" examples, Paperclip makes some helper methods 
available for generating the image path. All you need to do is access 
the "avatar" attribute on the User model and use its "url" method 
(passing in the style you want to use). This will then give you back the
 path to the specific file you want.</p>

<p>Check this out in action by looking at <a href="http://web.archive.org/web/20180731055857/https://github.com/robmclarty/paperclip-example">the example app</a>.</p>

<p>Hope that helps get some more file uploads and images into your Rails
 apps! Let me know if you have any questions or if I missed something. 
Thanks :)</p>

</article>

<footer class="global-footer">
♡
2018
by <strong>Rob McLarty</strong>. Copying is an act of love. Please copy.
<br>
<br>
<a href="http://web.archive.org/web/20180731055857/http://robmclarty.com/" style="margin-right: 10px;">Homepage</a>
<a class="icon twitter button small" href="http://web.archive.org/web/20180731055857/http://twitter.com/robmclarty" style="margin-right: 10px;">Twitter</a>
<a class="icon github button small" href="http://web.archive.org/web/20180731055857/http://github.com/robmclarty" style="margin-right: 10px;">Github</a>
<a class="icon email button small" href="http://web.archive.org/web/20180731055857/mailto:%72@%72%6f%62%6d%63%6c%61%72%74%79.%63%6f%6d" style="margin-right: 10px;">Email</a>

</footer>
</div>

<script src="How%20to%20Install%20Image%20Magick%20and%20Setup%20Paperclip%20_%20Rob%20McLarty_files/application-53836c59083b4056c599af386f0d9334.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-72855-15']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'http://web.archive.org/web/20180731055857/https://ssl' : 'http://web.archive.org/web/20180731055857/http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>




</body></html>
<!--
     FILE ARCHIVED ON 05:58:57 Jul 31, 2018 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 20:55:48 Sep 20, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 140.554
  exclusion.robots: 0.177
  exclusion.robots.policy: 0.171
  RedisCDXSource: 4.79
  esindex: 0.008
  LoadShardBlock: 116.633 (3)
  PetaboxLoader3.datanode: 205.157 (4)
  CDXLines.iter: 16.557 (3)
  load_resource: 158.003
  PetaboxLoader3.resolve: 49.362
-->