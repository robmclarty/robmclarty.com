<!DOCTYPE html>
<html lang="en"><script type="text/javascript" async="" src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/ga.js"></script><script type="module" src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/hook.js"></script><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><script src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/analytics.js" type="text/javascript"></script>
<script type="text/javascript">window.addEventListener('DOMContentLoaded',function(){var v=archive_analytics.values;v.service='wb';v.server_name='wwwb-app203.us.archive.org';v.server_ms=893;archive_analytics.send_pageview({});});</script>
<script type="text/javascript" src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/bundle-playback.js" charset="utf-8"></script>
<script type="text/javascript" src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/wombat.js" charset="utf-8"></script>
<script type="text/javascript">
  __wm.init("http://web.archive.org/web");
  __wm.wombat("http://robmclarty.com:80/blog/how-to-setup-a-production-server-for-rails-4","20180801081520","http://web.archive.org/","web","/_static/",
	      "1533111320");
</script>
<link rel="stylesheet" type="text/css" href="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/banner-styles.css">
<link rel="stylesheet" type="text/css" href="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/iconochive.css">
<!-- End Wayback Rewrite JS Include -->

<meta charset="utf-8">
<title>How to Setup a Production Server for Rails 4 // Rob McLarty</title>
<meta content="This blog is the first app I&amp;#39;ve made with Rails 4/Ruby 2 and this article explains how I installed it in production from a bare-bones virtual-dedicated server running Ubuntu, Apache, Passenger, and MySQL." name="description">
<meta content="Rob McLarty" name="application-name">
<meta content="Rob McLarty" name="author">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="IE-edge,chrome=1" http-equiv="X-UA-Compatible">
<meta content="no" http-equiv="MSThemeCompatible">
<link href="http://web.archive.org/web/20180801081520/http://robmclarty.com/feed" rel="alternate" title="RLog-Feed" type="application/atom+xml">
<link href="http://web.archive.org/web/20180801081520im_/http://robmclarty.com/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon">
<link href="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/application-4bf5c58eeb36f7ffe772634b49b3ee56.css" media="all" rel="stylesheet">

<meta content="authenticity_token" name="csrf-param">
<meta content="nonZ7bdbtbSLRX8X9N5+o9QfkEQvAiWf7JU8y2vCgSM=" name="csrf-token">

</head>
<body class=""><!-- BEGIN WAYBACK TOOLBAR INSERT -->
<style type="text/css">
body {
  margin-top:0 !important;
  padding-top:0 !important;
  /*min-width:800px !important;*/
}
</style>
<script>__wm.rw(0);</script>
<div id="wm-ipp-base" style="display: block; direction: ltr;" lang="en">
</div><div id="wm-ipp-print">The Wayback Machine - 
http://web.archive.org/web/20180801081520/http://robmclarty.com:80/blog/how-to-setup-a-production-server-for-rails-4</div>
<div id="donato" style="position:relative;width:100%;">
  <div id="donato-base">
    <iframe id="donato-if" src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/donate.html" scrolling="no" style="width:100%; height:100%" frameborder="0">
    </iframe>
  </div>
</div><script type="text/javascript">
__wm.bt(650,27,25,2,"web","http://robmclarty.com/blog/how-to-setup-a-production-server-for-rails-4","20180801081520",1996,"/_static/",["/_static/css/banner-styles.css?v=omkqRugM","/_static/css/iconochive.css?v=qtvMKcIJ"], "False");
  __wm.rw(1);
</script>
<!-- END WAYBACK TOOLBAR INSERT -->
<header class="global-header" style="background-image: url('/web/20180801081520im_/http://robmclarty.com/system/posts/banners/4/wires_large.jpg?1365561638');">
<h1 class="logo">Rob McLarty</h1>
<a alt="Back to Homepage" class="main-button" href="http://web.archive.org/web/20180801081520/http://robmclarty.com/blog" id="main-button" title="Back to Homepage">
How to Setup a Production Server for Rails 4 Banner
</a>
</header>
<div class="main">

<article class="post" id="post-4">
<h1 id="post-title">How to Setup a Production Server for Rails 4</h1>
<h2>This blog is the first app I've made with Rails 4/Ruby 2 and this 
article explains how I installed it in production from a bare-bones 
virtual-dedicated server running Ubuntu, Apache, Passenger, and MySQL.</h2>
<h3>Choose a Service Provider</h3>

<p>I already had an account with <a href="http://web.archive.org/web/20180801081520/http://mediatemple.net/">Media Temple</a>,
 so I thought that keeping all my cloud junk together and staying with 
MT would make things easier to manage, for me personally. I'm not 
getting paid to endorse MT in any way. Without my existing relationship I
 could have just as easily gone with something like <a href="http://web.archive.org/web/20180801081520/http://www.rackspace.com/cloud/vps/">Rackspace</a>, <a href="http://web.archive.org/web/20180801081520/http://www.linode.com/">Linode</a>, or even <a href="http://web.archive.org/web/20180801081520/https://www.heroku.com/">Heroku</a>.</p>

<p>I was previously using MT's <a href="http://web.archive.org/web/20180801081520/http://mediatemple.net/webhosting/dv/">DV server</a>
 which is a pre-installed setup that comes with a custom CentOS and Plex
 configuration. But I noticed that when using this setup for clients, 
each time I ordered a new one, the configurations changed and I had to 
figure out how to solve problems I had already dealt with when I wanted 
to put together the same small Rails/Passenger production system I've 
used for all my apps. I was looking for something I could repeat 
on-demand with minimal unknowns. I wanted a workable recipe for putting 
new apps online that could handle a moderate load and get any of my apps
 from MVP to scaling problems in a predictable manner (at which point, 
my thinking was, I'd be in a position to work with people smarter than 
me to help with more elaborate configurations).</p>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/Screen_Shot_2013-04-12_at_11.jpg" alt="Media Temple's VE Server Offering"></p>

<p>So for my production server (the one running this blog) I chose to go with Media Temple's <a href="http://web.archive.org/web/20180801081520/http://mediatemple.net/webhosting/ve/">VE server</a>.
 It's a fresh install of an OS of your choice that lets you start from 
scratch and maintain full control. The key is that it came blank and 
only included what I put on it myself. This allowed me to start from, 
and stay with, known variables and make the process I developed 
repeatable (making subsequent installs require a lot less grey matter).</p>

<h3>Install an Operating System</h3>

<p>My choice of OS was Ubuntu 11.04 (although I would have preferred 
12.04.2 LTS, but 11.04 is the newest version of Ubuntu MT offers). I 
wanted something newish and I wanted something with easy package 
management. Being based on Debian, Ubuntu gave me access to the great <a href="http://web.archive.org/web/20180801081520/http://en.wikipedia.org/wiki/Advanced_Packaging_Tool">Advanced Packaging Tool</a> (APT) which has made installing many libraries and dependencies a snap.</p>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/choose_os_large.jpg" alt="Ubuntu Operating System"></p>

<p>The following are the steps I took to get from brand-new Ubuntu install from Media Temple's account centre through to a working <a href="http://web.archive.org/web/20180801081520/http://www.ruby-lang.org/en/news/2013/02/24/ruby-2-0-0-p0-is-released/">Ruby 2.0</a> on <a href="http://web.archive.org/web/20180801081520/http://weblog.rubyonrails.org/2013/2/25/Rails-4-0-beta1/">Rails 4.beta</a> app running on <a href="http://web.archive.org/web/20180801081520/http://httpd.apache.org/">Apache 2</a> and <a href="http://web.archive.org/web/20180801081520/http://blog.phusion.nl/2013/03/05/phusion-passenger-4-0-release-candidate-4/">Phusion Passenger 4.rc4</a> (<a href="http://web.archive.org/web/20180801081520/http://blog.phusion.nl/2013/04/09/phusion-passenger-4-0-release-candidate-6/">rc6</a> just came out as I'm writing this).</p>

<h3>Create a Non-Root User</h3>

<p>The very first thing I did was create a new user on my new server that isn't <code>root</code>. Running everything as <code>root</code> is bad for security. In fact, I even disabled being able to login in as <code>root</code> so it's impossible for anyone to gain root-access to my server at all.</p>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/Screen_Shot_2013-04-12_at_11_002.jpg" alt="Media Temple Account Center"></p>

<p>In Media Temple's Account Centre (their web interface where you pay 
for the stuff) there are a few simple tools, one of which is for 
generating a new root user password. I generated a new super-strong 
password (I keep track of all my logins with <a href="http://web.archive.org/web/20180801081520/https://agilebits.com/onepassword">1Password</a>
 and use it to generate new unique passwords) and saved it through the 
web interface. That done, I left the web interface behind and jumped 
into the CLI to interact with the server via <a href="http://web.archive.org/web/20180801081520/http://en.wikipedia.org/wiki/Secure_Shell">SSH</a>.</p>

<p>On my local machine, in a terminal, I logged in like this (entering my password I just generated when prompted).</p>

<pre><code>ssh root@xxx.xxx.xxx.xxx
</code></pre>

<p>Once in, I created a new non-root user, and created a home directory 
while I was at it (for this article I'm going to use "bill" as the 
username).</p>

<pre><code>useradd -d /home/bill -m bill
</code></pre>

<p>Next, I made a good password for my new user (generating another 
strong password with 1Password, but you could just make one up yourself 
that jives with whatever password management process you use).</p>

<pre><code>passwd bill
</code></pre>

<p>And finally, I made my new user a sudoer so it (<em>aside</em>: does a user account on a server have a gender?) can do root level tasks when needed.</p>

<pre><code>visudo
</code></pre>

<p>This will open the <code>vi</code> text editor for the sudoer file (you're going to have to get your <code>hjkl</code> on to navigate the file; if you've never used <code>vi</code> before, here's a <a href="http://web.archive.org/web/20180801081520/http://www.lagmonster.org/docs/vi.html">cheatsheet</a>).
 I just added the following line below where the root user's privileges 
are defined (obviously, use your own username for your server).</p>

<pre><code>bill ALL=(ALL) ALL
</code></pre>

<h3>Setup SSH</h3>

<p>As I said before, it's a good security measure to prevent <code>root</code>
 from being able to login through SSH altogether (that's why I created a
 new user). It's also a good idea to use a non-standard port number for 
SSH so it's hard for automated bot scripts to figure out where to look 
in the first place. I noticed when I installed a new server previously 
and left the port at the standard 22, weird connections from Kazakhstan 
and Russia where constantly trying to gain access, albeit 
unsuccessfully. Better to make it that much harder for them to find you.</p>

<p>First, still logged in as <code>root</code>, I backed-up the existing <code>sshd_config</code> to root's home folder.</p>

<pre><code>cp /etc/ssh/sshd_config ~
</code></pre>

<p>Then, I edited the active config file.</p>

<pre><code>vi /etc/ssh/sshd_config
</code></pre>

<p>I changed the following lines to disable root login, use a 
non-standard SSH port number, and white-list my new user (note that the 
AllowUsers is added to the very bottom of the file).</p>

<pre><code>Port 4321
PermitRootLogin no
...
AllowUsers bill
</code></pre>

<p>Then I saved and reloaded the SSH daemon to enabled the new config settings.</p>

<pre><code>service ssh restart
</code></pre>

<p>or</p>

<pre><code>/etc/init.d/ssh restart
</code></pre>

<p>For the curious, you can list all current SSH connections to your server with the command <a href="http://web.archive.org/web/20180801081520/http://en.wikipedia.org/wiki/Netstat">netstat</a>. You'll sometimes be surprised with what's trying to access your server.</p>

<pre><code>netstat -algrep ssh
</code></pre>

<h3>Add RSA Key to Server</h3>

<p>Adding an RSA key to the server allows access without the need for 
inputting your password every time. If you use a strong password like 
me, this will save you some hassle (I use a 50 character password with 
upper and lower case letters, at least 10 numerals, and at least 10 
special symbols). This will also make it easier to run remote commands 
from your deployment scripts without being interrupted by password 
prompts so deployments go faster and smoother, requiring much less of 
your attention and making it possible for fast iterations.</p>

<p>On the remote server...</p>

<pre><code>mkdir ~/.ssh
</code></pre>

<p>On my local machine, after having already <a href="http://web.archive.org/web/20180801081520/https://help.ubuntu.com/community/SSH/OpenSSH/Keys">created an RSA key</a> in <code>~/.ssh</code> using <a href="http://web.archive.org/web/20180801081520/http://www.openssh.org/">OpenSSH</a>, I copied my public key to the remote server's <code>authorized_keys</code> file.</p>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/ssh-keygen_example-rob_large.jpg" alt="Example RSA Keygen Output"></p>

<pre><code>cat ~/.ssh/id_rsa.pub | ssh bill@xxx.xxx.xxx.xxx -p 4321 'cat - &gt;&gt; ~/.ssh/authorized_keys'
</code></pre>

<p>Back on the remote server, I changed the file permissions of <code>authorized_keys</code>.</p>

<pre><code>ssh bill@xxx.xxx.xxx.xxx

sudo chmod 600 ~/.ssh/authorized_keys &amp;&amp; chmod 700 ~/.ssh/
</code></pre>

<p>Then I checked the permissions on <code>authorized_keys</code> as a sanity check.</p>

<pre><code>ls -la ~/.ssh | grep "authorized_keys"
</code></pre>

<p>The output should be something like this:</p>

<pre><code>-rw------- 1 bill bill  403 2013-04-05 11:55 authorized_keys
</code></pre>

<p>And on ssh directory,</p>

<pre><code>ls -la ~ | grep ".ssh"
</code></pre>

<p>the output should be something like:</p>

<pre><code>drwx------  2 bill  bill  4096 2013-04-05 11:55 .ssh
</code></pre>

<h3>Install Apache and Dependencies</h3>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/apache-logo_large.jpg" alt="Apache HTTP Server"></p>

<p>Installing Apache has never been easier using <code>apt-get</code>.</p>

<p>First, I updated the repositories.</p>

<pre><code>sudo apt-get update
</code></pre>

<p>Then fixed the locales.</p>

<pre><code>sudo locale-gen en_US en_US.UTF-8 en_CA.UTF-8

sudo dpkg-reconfigure locales
</code></pre>

<p>And finally installed all the basic packages I thought I'd need.</p>

<pre><code>sudo apt-get install apache2 curl git build-essential zlibc zlib1g-dev zlib1g libcurl4-openssl-dev libssl-dev libopenssl-ruby apache2-prefork-dev libapr1-dev libaprutil1-dev libreadline6 libreadline6-dev
</code></pre>

<h3>Setup MySQL</h3>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/logo-mysql-small_large.jpg" alt="enter image description here"></p>

<p>I'm used to using <a href="http://web.archive.org/web/20180801081520/http://www.mysql.com/">MySQL</a>
 as my starting database server. You could alternatively use a more 
exotic NoSQL DB or Postgres or whatever floats your boat. Here I stuck 
with my old friend.</p>

<pre><code>sudo apt-get install mysql-server
</code></pre>

<p>Once installed, I needed to open a MySQL session using the server's root password so I could make a new database and user.</p>

<pre><code>mysql -p
</code></pre>

<p>From inside the mysql console, I created a new database, a database 
user, and assigned privileges to that user with a strong password (a <em>new</em> password for the database being created).</p>

<pre><code>create database billdb;

grant all privileges on billdb.* to 'billdb_usr'@'localhost' identified by 'a-super-strong-password';

flush privileges;
</code></pre>

<h3>Install Ruby + Rails From Source</h3>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/ruby_and_rails_large.jpg" alt="Ruby and Rails"></p>

<p>I wanted to setup the bleeding edge on this server, so I went with a 
source code install process for Ruby rather than a pre-existing package.
 I installed <a href="http://web.archive.org/web/20180801081520/http://www.ruby-lang.org/en/news/2013/02/24/ruby-2-0-0-p0-is-released/">Ruby 2.0</a> and Rails 4.beta. What I usually do to keep track of my source-code-installed components is create a <code>src</code>
 directory in my user's home folder inside which I store all my source 
code folders for compilation, installation, and later, any 
uninstallation I might need to do.</p>

<p>But before that, I needed to install a few more dependencies so my server environment was ready for it.</p>

<pre><code>sudo apt-get install build-essential libyaml-dev libsqlite3-0 libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion
</code></pre>

<p>Next, inside <code>/home/bill/src</code> and got the latest Ruby, decompressed it, configured, compiled, and installed.</p>

<pre><code>wget ftp://ftp.ruby-lang.org/pub/ruby/2.0/ruby-2.0.0-p0.tar.gz
tar xzvf ruby-2.0.0-p0.tar.gz
cd ruby-2.0.0-p0
./configure
make
sudo make install
</code></pre>

<p>Next, I made a symbolic link from <code>/usr/local/bin/ruby</code> to <code>/usr/bin/ruby</code> because some programs look for it there.</p>

<pre><code>sudo ln -s /usr/local/bin/ruby /usr/bin/ruby
</code></pre>

<p>The newer Rubies come with <code>rubygems</code> so you don't need to
 worry about installing that separately anymore. But before installing 
any new gems (like Rails) it's always a good idea to make sure it's up 
to date.</p>

<pre><code>sudo gem update --system
</code></pre>

<p>Finally, now that there was a convenient <code>beta1</code> branch for the Rails gem, all I needed to do was install the latest Rails was the following.</p>

<pre><code>sudo gem install rails --version 4.0.0.beta1
</code></pre>

<p>I encountered some weird issues with <code>rdoc</code> and <code>ri</code>
 where I had to answer "yes" to overwrite the existing versions. I just 
went with it since this is a dedicated server and I care more about the 
app working than some documentation that isn't necessary for me in 
production. I'm sure this will be fixed in the final release.</p>

<p><strong>Update</strong>: <a href="http://web.archive.org/web/20180801081520/http://twitter.com/kaspergrubbe">@kaspergrubbe</a> gave me a great little tweak so you don't need to specify <code>--no-ri --no-rdoc</code> every time you install a gem in production: just add <code>gem: --no-rdoc --no-ri</code> to <code>~/.gemrc</code> (create that file if it doesn't already exist) and don't worry about <code>ri</code> or <code>rdoc</code> again in production.</p>

<h3>Setup Passenger with Apache</h3>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/phusion_logo-300x168_large.jpg" alt="Phusion Passenger"></p>

<p>Phusion Passenger has been by far the easiest way I've found for 
managing multiple Rails application instances on top of either Apache or
 Nginx. It comes as a gem and has custom modules for both major web 
servers. For Rails 4 I wanted to go with the latest version, which is 
already packaged up into <code>pre</code> for easy installation through <code>rubygems</code>.</p>

<pre><code>sudo gem install passenger --pre
</code></pre>

<p>Once the gem was installed, I just ran the custom source compilation 
script to get the web server modules installed. I chose to go with 
Apache, so I'm using the Apache install script. For Nginx, you'd just 
use <code>passenger-install-nginx-module</code> instead.</p>

<pre><code>sudo passenger-install-apache2-module
</code></pre>

<p>The first time I ran <code>passenger-install-apache2-module</code> I encountered an error because it wanted to use <code>/tmp</code> to execute temporary code, but <code>/tmp</code> was set to <code>noexec</code>
 by default which prevents this (this is a good thing, so remote 
attackers can't execute arbitrary code where the server stores uploaded 
files). The error shows up as an issue with <code>curl</code>.</p>

<p>To work around this issue, rather than remounting the real <code>/tmp</code>, I temporarily bound <code>~/tmp</code> to <code>/tmp</code> and then unmounted it when I was finished.</p>

<pre><code>mkdir ~/tmp
sudo mount --bind ~/tmp /tmp
sudo passenger-install-apache2-module
sudo umount /tmp
</code></pre>

<p><strong>Update</strong>: Hongli Lai from <a href="http://web.archive.org/web/20180801081520/http://www.phusion.nl/">Phusion</a> writes that "you
can just run <code>passenger-install-apache2-module</code> with the <code>TMPDIR</code>
environment variable set to a directory without <code>noexec</code>" so you don't need to bind-mount the <code>/tmp</code> directory to work around the above issue.</p>

<p>With passenger installed, I then added two files to <code>/etc/apache2/mods-available</code>.
 The Debian Apache package manages modules and sites through directories
 and symlinks rather than a single monolithic config file. This is new 
to me, but I like it. (<a href="http://web.archive.org/web/20180801081520/http://www.control-escape.com/web/configuring-apache2-debian.html">read more</a>)</p>

<p>First, I created a file called <code>/etc/apache2/mods-available/passenger.load</code> and input the following code:</p>

<pre><code>LoadModule passenger_module /usr/local/lib/ruby/gems/2.0.0/gems/passenger-4.0.0.rc4/libout/apache2/mod_passenger.so
</code></pre>

<p>Second, I created a file called <code>/etc/apache2/mods-available/passenger.conf</code> and input the following code (you could tweak these settings, but I've found this is a good starting point):</p>

<pre><code>PassengerRoot /usr/local/lib/ruby/gems/2.0.0/gems/passenger-4.0.0.rc4
PassengerRuby /usr/local/bin/ruby
PassengerMaxPoolSize 6
PassengerPoolIdleTime 0
PassengerMaxRequests 1000
</code></pre>

<p>Then, I enabled the passenger module in Apache and restarted server.</p>

<pre><code>sudo a2enmod passenger
sudo service apache2 restart
</code></pre>

<p>I then checked what modules apache was loading to verify passenger 
was in the list. At first it wasn't working for me because I hadn't 
activated the module using the <code>a2enmod</code> command. So this is a useful check:</p>

<pre><code>apache2ctl -t -D DUMP_MODULES
</code></pre>

<h3>Create an App and Test All the Connections</h3>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/test_app_todos_large.jpg" alt="Test App: Todos"></p>

<p>Finally, I created a test app directly on the remote server and fired
 it up to check that all the different pieces I just installed were 
working together.</p>

<p>First, I moved the default apache page to its own directory so I 
could put other custom directories of my own (like for my app) in the <code>www</code> directory and not have a default <code>index.html</code> file capable of rendering at its root.</p>

<pre><code>sudo mkdir /var/www/default
sudo mv /var/www/index.html /var/www/default/index.html
</code></pre>

<p>I usually make all folders directly under <code>www</code> the name of the domain or site I want to serve (e.g., <code>/var/www/robmclarty.com</code>). Later, if I want to make a separate microsite on a subdomain or something, I can make a new folder here (e.g., <code>/var/www/subdomain.robmclarty.com</code>).</p>

<p>Next, I edited the default apache <code>vhost</code> to point to <code>/etc/apache2/sites-available/default</code></p>

<pre><code>…
DocumentRoot /var/www/default
…
&lt;Directory /var/www/default/&gt;
…
Options FollowSymLinks # Remove Indexes
</code></pre>

<p><strong>Update</strong>: Dan Vokt writes that it would be easier to just use the <code>a2ensite</code> command to do this... I didn't think of that because I'm new to managing things with this command. Thanks Dan!</p>

<p>Then I created a new test app with a mysql setup, to kick the tires 
and ensure the server was properly configured (this is done from inside 
the <code>/var/www/default</code> directory). I added a simple 'todo' scaffold with a <code>name</code> and a <code>finished</code>
 attribute that could be the beginning of a basic todo-list app (just to
 test some actual usage, not simply loading the default page).</p>

<pre><code>sudo rails new testapp --skip-bundle -d mysql
cd testapp
sudo bundle install
sudo rails g scaffold todo name:string finished:boolean
</code></pre>

<p>I edited <code>database.yml</code> to connect to the database I made earlier.</p>

<pre><code>production:
  adapter:  mysql2
  encoding: utf8
  database: billdb
  username: billdb_usr
  password: your-super-strong-password
</code></pre>

<p>I edited <code>routes.rb</code> to make the default view point to something real.</p>

<pre><code>root to: 'todos#index'
</code></pre>

<p>And finally I updated the app and restarted passenger.</p>

<pre><code>sudo bundle install --deployment --without development test
sudo bundle exec rake db:migrate RAILS_ENV=production
sudo bundle exec rake assets:precompile RAILS_ENV=production
sudo touch /var/www/testapp/tmp/restart.txt
</code></pre>

<h3>Configure Virtual Host to Point to App</h3>

<p>The final step in configuring the server was to setup a custom 
virtual host to point Apache to the new app directly (i.e., without 
needing to use any port numbers or anything). To do that, I edited the 
file <code>/etc/apache2/sites-available/testapp</code>.</p>

<pre><code>&lt;VirtualHost _default_:80&gt;
   # ServerName www.yourhost.com # Commented out for default
   DocumentRoot /var/www/testapp/public # be sure to point to public
   &lt;Directory /var/www/testapp/public&gt;
      AllowOverride all
      Options -MultiViews
   &lt;/Directory&gt;
&lt;/VirtualHost&gt;
</code></pre>

<p>I activated the new site.</p>

<pre><code>sudo a2ensite testapp
</code></pre>

<p>I deactivated the default site.</p>

<pre><code>sudo a2dissite default
</code></pre>

<p>And reloaded apache to enabled the new configurations.</p>

<pre><code>sudo service apache2 reload
</code></pre>

<p>That's it! Now, when I pointed to my server's IP address I was able 
to see my newly created Rails app and it worked properly (albeit with no
 authentication, haha).</p>

<p><img src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/ruby2_large.jpg" alt="Bruce Lee Rails"></p>

<p>In <a href="http://web.archive.org/web/20180801081520/http://robmclarty.com/blog/how-to-deploy-a-rails-4-app-with-git-and-capistrano">a future post</a>,
 I'll walk through setting up a new app locally and using capsitrano to 
deploy it to the production server, as well as installing ImageMagick 
for doing fancy image processing server-side when users upload bitmaps 
to your app.</p>

<p>If you have any questions, or notice something in this process that could be improved, please <a href="mailto:r@robmclarty.com">let me know</a>.</p>

<h3>Update</h3>

<p>This post was featured <a href="http://web.archive.org/web/20180801081520/http://ruby5.envylabs.com/episodes/371-episode-367-may-7th-2013/stories/3239-how-to-setup-a-production-server-for-rails-4">on Ruby5</a> and <a href="http://web.archive.org/web/20180801081520/http://rubyweekly.com/archive/144.html">Ruby Weekly</a>. Thanks guys!</p>

<p>Kurt Sussman emailed me with some good suggestions to fine-tune your server setup even further:</p>

<ol>
<li><p>Use <code>ssh-copy-id</code> to <a href="http://web.archive.org/web/20180801081520/http://www.thegeekstuff.com/2008/11/3-steps-to-perform-ssh-login-without-password-using-ssh-keygen-ssh-copy-id/">get your public key onto your server</a> in fewer steps. I wasn't sure how to do this with a custom port number, but found <a href="http://web.archive.org/web/20180801081520/http://unix.stackexchange.com/questions/29401/is-it-possible-to-run-ssh-copy-id-on-port-other-than-22">some solutions</a> to get around this.</p></li>
<li><p>Speed up Ruby even further with some environment variable tuning (<code>tcmalloc</code> lib can be installed via <code>apt-get</code>):</p>

<pre><code> export RUBY_GC_MALLOC_LIMIT=1000000000
 export RUBY_HEAP_SLOTS_GROWTH_FACTOR=1.25
 export RUBY_HEAP_MIN_SLOTS=800000
 export RUBY_FREE_MIN=600000
 export LD_PRELOAD=/usr/lib/libtcmalloc_minimal.so.4
</code></pre></li>
<li><p>Consider using a provisioning script to automate all this setup nonesense like <a href="http://web.archive.org/web/20180801081520/https://github.com/phred/5minbootstrap">5minbootstrap</a>.</p></li>
</ol>


</article>

<footer class="global-footer">
♡
2018
by <strong>Rob McLarty</strong>. Copying is an act of love. Please copy.
<br>
<br>
<a href="http://web.archive.org/web/20180801081520/http://robmclarty.com/" style="margin-right: 10px;">Homepage</a>
<a class="icon twitter button small" href="http://web.archive.org/web/20180801081520/http://twitter.com/robmclarty" style="margin-right: 10px;">Twitter</a>
<a class="icon github button small" href="http://web.archive.org/web/20180801081520/http://github.com/robmclarty" style="margin-right: 10px;">Github</a>
<a class="icon email button small" href="http://web.archive.org/web/20180801081520/mailto:%72@%72%6f%62%6d%63%6c%61%72%74%79.%63%6f%6d" style="margin-right: 10px;">Email</a>

</footer>
</div>

<script src="How%20to%20Setup%20a%20Production%20Server%20for%20Rails%204%20_%20Rob%20McLarty_files/application-53836c59083b4056c599af386f0d9334.js"></script>

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-72855-15']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'http://web.archive.org/web/20180801081520/https://ssl' : 'http://web.archive.org/web/20180801081520/http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>




</body></html>
<!--
     FILE ARCHIVED ON 08:15:20 Aug 01, 2018 AND RETRIEVED FROM THE
     INTERNET ARCHIVE ON 20:54:15 Sep 20, 2021.
     JAVASCRIPT APPENDED BY WAYBACK MACHINE, COPYRIGHT INTERNET ARCHIVE.

     ALL OTHER CONTENT MAY ALSO BE PROTECTED BY COPYRIGHT (17 U.S.C.
     SECTION 108(a)(3)).
-->
<!--
playback timings (ms):
  captures_list: 168.309
  exclusion.robots: 0.203
  exclusion.robots.policy: 0.195
  RedisCDXSource: 2.254
  esindex: 0.009
  LoadShardBlock: 144.036 (3)
  PetaboxLoader3.datanode: 84.335 (4)
  CDXLines.iter: 16.154 (3)
  load_resource: 717.537
  PetaboxLoader3.resolve: 35.183
-->